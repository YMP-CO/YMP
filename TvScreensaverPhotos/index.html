<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Выбор фото из Google Photos</title>
  <style>
    body {
      transition: background-image 0.5s ease;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: cover;
      background-position: center;
    }
  </style>
</head>
<body>
  <h1>Выбор фото из Google Photos</h1>
  <button id="login-button">Войти через Google</button>
  <button id="select-photo" style="display:none;">Выбрать фото из Google Photos</button>

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = '666120907144-uqjrqt97dja11m8qki68o83s0lt6j50k.apps.googleusercontent.com ';
    const REDIRECT_URI = 'http://ymp-co.github.io/TvScreensaverPhotos/index.html';
    const SCOPE = 'https://www.googleapis.com/auth/photoslibrary.readonly';
    const AUTH_URL = 'https://accounts.google.com/o/oauth2/v2/auth';
    const API_KEY = 'AIzaSyAocyYlBmQmguCP7zEsqMmzHrqhig-aRX0';

    const loginButton = document.getElementById('login-button');
    const selectPhotoButton = document.getElementById('select-photo');

    loginButton.addEventListener('click', () => {
      const authUrl = `${AUTH_URL}?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${SCOPE}`;
      window.location.href = authUrl;
    });

    function onApiLoad() {
      gapi.load('auth', {'callback': onAuthApiLoad});
      gapi.load('picker'); // Загрузка Picker API
    }

    function onAuthApiLoad() {
      selectPhotoButton.style.display = 'block'; // Показать кнопку выбора фото
    }

    function openPicker() {
      const picker = new google.picker.PickerBuilder()
        .addView(google.picker.ViewId.PHOTO_PICKER)
        .setOAuthToken(accessToken)
        .setDeveloperKey(API_KEY)
        .setCallback(pickerCallback)
        .build();
      picker.setVisible(true);
    }

    function pickerCallback(data) {
      if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
        const doc = data[google.picker.Response.DOCUMENTS][0];
        const imageUrl = doc[google.picker.Document.URL];
        setBackground(imageUrl);
      }
    }

    selectPhotoButton.addEventListener('click', openPicker);

    function setBackground(imageUrl) {
      document.body.style.backgroundImage = `url(${imageUrl})`;
      localStorage.setItem('backgroundImage', imageUrl);
    }

    window.onload = () => {
      const cachedImage = localStorage.getItem('backgroundImage');
      if (cachedImage) {
        setBackground(cachedImage);
      }
      const accessToken = getAccessTokenFromUrl();
      if (accessToken) {
        onApiLoad();
      }
    };

    function getAccessTokenFromUrl() {
      const urlParams = new URLSearchParams(window.location.hash.substring(1));
      return urlParams.get('access_token');
    }
  </script>
</body>
</html>
