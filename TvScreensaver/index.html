<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Фото Выбор</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400&display=swap">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      background-color: #303030;
      color: white;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    /* Часы */
    #time-container {
      position: absolute;
      bottom: 100px;
      left: 16px;
      font-size: 50px;
      font-weight: 300;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    #time-container .background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: -1;
      border-radius: 8px;
    }

    /* Кнопки авторизации, выхода и выбора */
    #auth-container {
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      z-index: 10;
    }

    .mdl-button {
      background-color: #4285f4;
      color: white;
      font-size: 16px;
      text-transform: none;
    }

    .mdl-button.logout {
      background-color: transparent;
      color: #ccc;
      font-size: 12px;
      text-transform: none;
      border: 1px solid #ccc;
      margin-top: 8px;
    }

    .mdl-button.logout:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .mdl-button:hover {
      background-color: #357ae8;
    }

    /* Окно выбора фотографии */
    #photo-dialog {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 400px;
      height: 600px;
      background-color: #424242;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      padding: 16px;
      z-index: 20;
      transform: translateY(100%);
      transition: transform 0.3s ease-in-out;
    }

    #photo-dialog.active {
      display: flex;
      transform: translateY(0);
    }

    #photo-dialog .title {
      font-size: 18px;
      margin-bottom: 16px;
      color: white;
    }

    .photo-grid {
      flex-grow: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* Сетка 3 столбца */
      grid-template-rows: repeat(5, 1fr);  /* Сетка 5 строк */
      gap: 8px;
      overflow-y: auto;
      padding-bottom: 16px;
    }

    .photo-item {
      position: relative;
      cursor: pointer;
      border-radius: 4px;
      overflow: hidden;
      width: 100%;
      height: 0;
      padding-bottom: 100%; /* Соотношение 1:1 */
      transition: transform 0.2s;
    }

    .photo-item img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover; /* Изображения обрезаются, чтобы сохранить пропорции */
    }

    .photo-item.selected {
      outline: 3px solid #4285f4;
    }

    .photo-item:hover {
      transform: scale(1.05);
    }

    /* Крестик для закрытия */
    #close-button {
      position: absolute;
      top: 8px;
      right: 8px;
      cursor: pointer;
      font-size: 20px;
      color: white;
      background: transparent;
      border: none;
      outline: none;
    }

    #close-button:focus {
      color: #4285f4;
    }

    /* Стилизация скроллбара */
    .photo-grid::-webkit-scrollbar {
      width: 8px;
    }

    .photo-grid::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .photo-grid::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <!-- Часы -->
  <div id="time-container">
    <div class="background"></div>
    <div id="clock"></div>
  </div>

  <!-- Кнопки авторизации, выбора и выхода -->
  <div id="auth-container">
    <button id="auth-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
      Войти через Google
    </button>
    <button id="choose-photo-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="display: none;">
      Выбрать изображение
    </button>
    <button id="logout-button" class="mdl-button logout mdl-js-button mdl-js-ripple-effect" style="display: none;">
      Выйти из аккаунта
    </button>
  </div>

  <!-- Окно выбора фотографии -->
  <div id="photo-dialog">
    <button id="close-button" title="Закрыть">×</button>
    <div class="title">Выберите изображение из Google Фото:</div>
    <div class="photo-grid" id="photo-grid"></div>
  </div>

  <script>
    const CLIENT_ID = '666120907144-uqjrqt97dja11m8qki68o83s0lt6j50k.apps.googleusercontent.com';
    const REDIRECT_URI = 'https://ymp-co.github.io/TvScreensaver/index.html';
    const SCOPE = 'https://www.googleapis.com/auth/photoslibrary.readonly';
    const AUTH_URL = 'https://accounts.google.com/o/oauth2/v2/auth';

    let accessToken = null;
    let photos = [];
    let selectedIndex = 0;

    // Обновление времени
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('clock').textContent = timeString;
    }

    setInterval(updateTime, 1000);
    updateTime();

    // Открыть окно авторизации
    function openAuth() {
      const authUrl = `${AUTH_URL}?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${SCOPE}`;
      window.location.href = authUrl;
    }

    // Получить access_token из URL
    function getAccessToken() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    }

    // Получить фотографии
    async function fetchPhotos() {
      const response = await fetch('https://photoslibrary.googleapis.com/v1/mediaItems', {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      const data = await response.json();
      return data.mediaItems || [];
    }

    // Рендер фотографий
    function renderPhotos() {
      const photoGrid = document.getElementById('photo-grid');
      photoGrid.innerHTML = '';

      photos.forEach((photo, index) => {
        const photoItem = document.createElement('div');
        photoItem.classList.add('photo-item');

        const img = document.createElement('img');
        img.src = `${photo.baseUrl}=w300-h300-c`;
 img.alt = photo.filename || `Фото ${index + 1}`;

        photoItem.appendChild(img);
        photoItem.addEventListener('click', () => {
          selectedIndex = index;
          const highResolutionUrl = `${photo.baseUrl}=d`;
          document.body.style.backgroundImage = `url(${highResolutionUrl})`;
          localStorage.setItem('backgroundImage', highResolutionUrl); // Сохранение в кеш
          closePhotoDialog();
        });

        photoGrid.appendChild(photoItem);
      });
    }

    // Открыть/закрыть окно выбора фотографий
    function openPhotoDialog() {
      const dialog = document.getElementById('photo-dialog');
      dialog.style.display = 'flex';
      setTimeout(() => dialog.classList.add('active'), 10);
    }

    function closePhotoDialog() {
      const dialog = document.getElementById('photo-dialog');
      dialog.classList.remove('active');
      setTimeout(() => {
        dialog.style.display = 'none';
      }, 300);
    }

    // Выйти из аккаунта
    function logout() {
      localStorage.clear(); // Очистка кеша
      accessToken = null;
      window.location.href = window.location.pathname; // Перезагрузка страницы
    }

    // Загрузка сохраненного фона из кеша
    function loadCachedBackground() {
      const cachedBackground = localStorage.getItem('backgroundImage');
      if (cachedBackground) {
        document.body.style.backgroundImage = `url(${cachedBackground})`;
      }
    }

    // Инициализация
    async function init() {
      loadCachedBackground(); // Загрузка сохраненного фона

      accessToken = getAccessToken();

      if (!accessToken) {
        document.getElementById('auth-button').style.display = 'block';
        document.getElementById('choose-photo-button').style.display = 'none';
        document.getElementById('logout-button').style.display = 'none';
      } else {
        document.getElementById('auth-button').style.display = 'none';
        document.getElementById('choose-photo-button').style.display = 'block';
        document.getElementById('logout-button').style.display = 'block';

        try {
          photos = await fetchPhotos();
          renderPhotos();
        } catch (error) {
          console.error('Ошибка загрузки фотографий:', error);
        }
      }
    }

    // Обработчики событий
    document.getElementById('auth-button').addEventListener('click', openAuth);
    document.getElementById('choose-photo-button').addEventListener('click', openPhotoDialog);
    document.getElementById('close-button').addEventListener('click', closePhotoDialog);
    document.getElementById('logout-button').addEventListener('click', logout);

    init();
  </script>
</body>
</html>
